<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
</head>

<body style="overflow: hidden;">
    <title>capture microphone audio into buffer</title>

    <div style="background-color: lightgray; min-height: 30px; padding: 0;">
        <div id="barra-progreso" style="background-color: blue; width: 30%; margin: 0; padding: 0;">&nbsp;</div>
    </div>

    <div style="background-color: lightgray; min-height: 30px; padding: 0;">
        <div id="barra-progreso2" style="background-color: red; width: 30%; margin: 0; padding: 0;">&nbsp;</div>
    </div>

    <div id="chart"></div>

    <button onclick="startMicrophone()">Start Microphone</button>

    <script>
        var ventanas = [];
        var MAX_VENTANAS = 7;
        var BUFF_SIZE = 16384;
        var audioContext;

        async function startMicrophone() {
            try {
                // Create audio context after a user gesture
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                await audioContext.audioWorklet.addModule('microphone-processor.js');

                const audioWorkletNode = new AudioWorkletNode(audioContext, 'microphone-processor');
                audioWorkletNode.port.onmessage = processMicrophoneBuffer;

                const microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const microphoneSource = audioContext.createMediaStreamSource(microphoneStream);
                microphoneSource.connect(audioWorkletNode);

            } catch (error) {
                showError('Error setting up audio worklet.');
            }
        }

        function showError(message) {
            alert(message);
        }

        function processMicrophoneBuffer(event) {
    try {
        if (!event || !event.data || !event.data[0]) {
            throw new Error('Invalid microphone buffer data.');
        }

        const microphoneOutputBuffer = event.data[0];
        let sum = 0;

        for (let i = 0; i < BUFF_SIZE; i++) {
            sum += Math.abs(microphoneOutputBuffer[i]);
        }

        const average = sum / BUFF_SIZE;
        document.getElementById("barra-progreso").style.width = Math.floor(average * 100) + "%";

        if (ventanas.length >= MAX_VENTANAS) {
            ventanas.shift();
        }

        ventanas.push(average);

        const sumVentanas = ventanas.reduce((acc, val) => acc + val, 0) / (MAX_VENTANAS * BUFF_SIZE);
        console.log(sumVentanas);
        document.getElementById("barra-progreso2").style.width = Math.floor(sumVentanas * 1000000) + "%";
    } catch (error) {
        showError(error.message);
    }
}
    </script>
</body>
</html>
