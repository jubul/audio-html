<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
</head>

<body style="overflow: hidden;">
    <title>capture microphone audio into buffer</title>

    <div style="background-color: lightgray; min-height: 30px; padding: 0;">
        <div id="barra-progreso" style="background-color: blue; width: 30%; margin: 0; padding: 0;">&nbsp;</div>
    </div>

    <div style="background-color: lightgray; min-height: 30px; padding: 0;">
        <div id="barra-progreso2" style="background-color: red; width: 30%; margin: 0; padding: 0;">&nbsp;</div>
    </div>

    <div id="chart"></div>

    <script>
        var ventanas = [];
        var MAX_VENTANAS = 7;
        var BUFF_SIZE = 16384;

        var webaudio_tooling_obj = async function () {
            console.log("Starting up...");
            var audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            try {
                await audioContext.audioWorklet.addModule('microphone-processor.js');

                const audioWorkletNode = new AudioWorkletNode(audioContext, 'microphone-processor');
                audioWorkletNode.port.onmessage = processMicrophoneBuffer;

                const microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const microphoneSource = audioContext.createMediaStreamSource(microphoneStream);
                microphoneSource.connect(audioWorkletNode);

            } catch (error) {
                showError('Error setting up audio worklet.');
            }

            function showError(message) {
                alert(message);
            }

            function processMicrophoneBuffer(event) {
                const microphoneOutputBuffer = event.data;
                let sum = 0;

                for (let i = 0; i < BUFF_SIZE; i++) {
                    sum += Math.abs(microphoneOutputBuffer[i]);
                }

                const average = sum / BUFF_SIZE;
                document.getElementById("barra-progreso").style.width = Math.floor(average * 100) + "%";

                if (ventanas.length >= MAX_VENTANAS) {
                    ventanas.shift();
                }

                ventanas.push(average);

                const sumVentanas = ventanas.reduce((acc, val) => acc + val, 0) / (MAX_VENTANAS * BUFF_SIZE);
                console.log(sumVentanas);
                document.getElementById("barra-progreso2").style.width = Math.floor(sumVentanas * 1000000) + "%";
            }
        }(); //  webaudio_tooling_obj = function()
    </script>
</body>
</html>
